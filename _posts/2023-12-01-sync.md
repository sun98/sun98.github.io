# 1. 同步原语

三大同步原语：mutex，semaphore，condition variable。

## 1.1. mutex
mutex有以下细节需要注意：
- **排他性**：一次只允许一个线程持有，被占有后，其他尝试获取的线程会进入blocked状态；
- **递归**：Linux中的mutex分为递归（重入）的和非递归（不可重入）的，即是否允许同一个线程多次获取和释放。

  多次获取递归mutex，会嵌套持有，增加锁的计数器，必须使用等量的释放动作才可完全释放锁。

  多次获取非递归的mutex，会导致死锁。
- **睡眠与唤醒**：无法获取到mutex时，线程会被放到阻塞队列中，直到mutex被其他线程释放，然后会进入就绪队列，等待重新调度。
- **优先级继承**：高优先级的线程等待低优先级持有的mutex，会形成优先级翻转，可能导致线程饿死，Linux中的mutex实现了优先级继承，该情况下会暂时提高低优先级线程的优先级。
- **公平性**：Linux中的mutex倾向于公平分配，按照请求顺序让线程获取锁，还有其他类型的策略。
- **内存语义**：大部分mutex都提供了内存屏障，确保锁保护下的数据的操作不会因为编译器优化、乱序执行导致不可预期的结果。

## 1.2. semaphore
semaphore的细节：
- **限制并发**：可以限制同时访问某资源的线程数量，而mutex同时仅允许一个线程访问资源。

  场景1：（单方向限制下限）电影院有100张票，设置初始值为100的semaphore，每次被购买就是用release，直到值为0时不可购买。

  场景2：（双向限制上限和下限）使用信号量和有限长队列解决生产者消费者问题，用两个semaphore，一个表示队列剩余元素个数，一个表示队列剩余容量，可以双向控制队列元素数量处于0~max之间。
- **用途**：限制同时访问某资源的线程数（见上）。除此之外，还可用于进程间通信，配合内存映射文件使用，使不同进程使用同一个semaphore，在 POSIX API中，semaphore创建时需要提供一个路径名，这样多个不同的进程使用同一个路径，即可使用同一个semaphore。

### 1.2.1. Q\&As
- 如果把semaphore的最大值设置为1，它和mutex有什么区别吗？
